import { CSSProperties, useEffect, useRef, useState } from 'react';
import '../css/countDown.less';

export type CountdownProps = {
  duration: number;
  onCountdownEnd: () => void;
  label?: string;
  onCancel?: () => void;
}

/*
window.CSS.registerProperty({
  name: "--clock-hands-position",
  syntax: "<percentage>",
  inherits: false,
  initialValue: "100%",
});
 */

export default function Countdown( {
  duration = 5,
  label = '',
  onCountdownEnd,
  onCancel
} : CountdownProps ) {
  const [ secondsLeft, setSecondsLeft ] = useState<number>( duration );
  const [ isCanceled, setIsCanceled ] = useState<boolean>( false );
  const [ isCounting, setIsCounting ] = useState<boolean>( false );

  const ref = useRef<HTMLDivElement>(null);

  useEffect( () => {
    !isCanceled && window.setTimeout( () => {
      if( secondsLeft > 0 ){
        setSecondsLeft( secondsLeft - 1 );
      } else {
        onCountdownEnd && onCountdownEnd();
      }
    }, 1000 );
  }, [ isCanceled, secondsLeft, onCountdownEnd ] );

  useEffect(() => {
    if( !isCanceled && !isCounting ) {
      window.setTimeout( () => setIsCounting(true), 250 );
    }
  }, [ isCanceled ] );

  return <>
    {label && <p className="countdown-label">{label}</p>}
    <div
      className="countdown-container"
      style={{ '--countdown-duration' : `${duration}s` } as CSSProperties}
    >
      <div
        className="btn-cancel"
        onClick={() => {
          setIsCanceled( true );
          onCancel && onCancel();
        }}
      />
      <div
        ref={ref}
        className={ `countdown${ isCounting ? ' counting' : '' }` }
      >
        <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 600 600">
          <g id="all_ticks">
            <g id="Layer_11">
              <g id="Layer_12">
                <path className="st0" d="M62.3828,304.2236v-7.8215H27.9681v7.8215h34.4146Z"/>
                <path className="st0" d="M572.3838,304.2236v-7.8215h-34.4146v7.8215h34.4146Z"/>
              </g>
              <g id="Layer_13">
                <path className="st0" d="M63.0882,279.232l.8175-7.7784-34.225-3.5971-.8175,7.7784,34.225,3.5971Z"/>
                <path className="st0" d="M570.28,332.5388l.8175-7.7784-34.225-3.5971-.8175,7.7784,34.225,3.5971Z"/>
              </g>
              <g id="Layer_14">
                <path className="st0" d="M66.5379,254.5518l1.626-7.6504-33.6616-7.1543-1.626,7.6504,33.6616,7.1543Z"/>
                <path className="st0" d="M565.3796,360.5738l1.626-7.6504-33.6616-7.1543-1.626,7.6504,33.6616,7.1543Z"/>
              </g>
              <g id="Layer_15">
                <path className="st0" d="M72.5859,230.3985l2.417-7.4384-32.729-10.6348-2.417,7.4384,32.729,10.6348Z"/>
                <path className="st0" d="M557.6068,387.9996l2.417-7.4384-32.729-10.6348-2.417,7.4384,32.729,10.6348Z"/>
              </g>
              <g id="Layer_16">
                <path className="st0" d="M81.1254,207.0209l3.1812-7.1449-31.4377-13.9972-3.1812,7.1449,31.4377,13.9972Z"/>
                <path className="st0" d="M547.0103,414.45l3.1812-7.1449-31.4377-13.9972-3.1812,7.1449,31.4377,13.9972Z"/>
              </g>
              <g id="Layer_17">
                <path className="st0" d="M92.1015,184.6243l3.9105-6.7732-29.8019-17.2063-3.9105,6.7732,29.8019,17.2063Z"/>
                <path className="st0" d="M533.7455,439.6093l3.9105-6.7732-29.8019-17.2063-3.9105,6.7732,29.8019,17.2063Z"/>
              </g>
              <g id="Layer_18">
                <path className="st0" d="M105.3168,163.5003l4.5968-6.3272-27.8395-20.2257-4.5968,6.3272,27.8395,20.2257Z"/>
                <path className="st0" d="M517.8794,463.2319l4.5968-6.3272-27.8395-20.2257-4.5968,6.3272,27.8395,20.2257Z"/>
              </g>
              <g id="Layer_19">
                <path className="st0" d="M120.6222,143.8621l5.233-5.8119-25.5726-23.0252-5.233,5.8119,25.5726,23.0252Z"/>
                <path className="st0" d="M499.59,485.0794l5.233-5.8119-25.5726-23.0252-5.233,5.8119,25.5726,23.0252Z"/>
              </g>
              <g id="Layer_110">
                <path className="st0" d="M137.9366,125.9406l5.8117-5.2329-23.0246-25.5715-5.8117,5.2329,23.0246,25.5715Z"/>
                <path className="st0" d="M479.1461,504.8928l5.8117-5.2329-23.0246-25.5715-5.8117,5.2329,23.0246,25.5715Z"/>
              </g>
              <g id="Layer_111">
                <path className="st0" d="M157.0598,109.9634l6.3268-4.5966-20.2252-27.8379-6.3268,4.5966,20.2252,27.8379Z"/>
                <path className="st0" d="M456.7834,522.5027l6.3268-4.5966-20.2252-27.8379-6.3268,4.5966,20.2252,27.8379Z"/>
              </g>
              <g id="Layer_112">
                <path className="st0" d="M177.7097,96.0799l6.7722-3.91-17.2042-29.7977-6.7722,3.91,17.2042,29.7977Z"/>
                <path className="st0" d="M432.6636,537.6617l6.7722-3.91-17.2042-29.7977-6.7722,3.91,17.2042,29.7977Z"/>
              </g>
              <g id="Layer_113">
                <path className="st0" d="M199.7383,84.4244l7.1436-3.1806-13.9946-31.4319-7.1436,3.1806,13.9946,31.4319Z"/>
                <path className="st0" d="M407.1286,550.2237l7.1436-3.1806-13.9946-31.4319-7.1436,3.1806,13.9946,31.4319Z"/>
              </g>
              <g id="Layer_114">
                <path className="st0" d="M222.8618,75.1317l7.4367-2.4164-10.6322-32.7216-7.4367,2.4164,10.6322,32.7216Z"/>
                <path className="st0" d="M380.4239,560.0436l7.4367-2.4164-10.6322-32.7216-7.4367,2.4164,10.6322,32.7216Z"/>
              </g>
              <g id="Layer_115">
                <path className="st0" d="M246.8242,68.3001l7.6485-1.626-7.1543-33.6532-7.6485,1.626,7.1543,33.6532Z"/>
                <path className="st0" d="M352.8462,567.0173l7.6485-1.626-7.1543-33.6532-7.6485,1.626,7.1543,33.6532Z"/>
              </g>
              <g id="Layer_116">
                <path className="st0" d="M271.3836,64.0028l7.7765-.8173-3.5961-34.2166-7.7765.8173,3.5961,34.2166Z"/>
                <path className="st0" d="M324.6747,571.07l7.7765-.8173-3.5961-34.2166-7.7765.8173,3.5961,34.2166Z"/>
              </g>
              <g id="Layer_117">
                <path className="st0" d="M62.057,304.2653v-7.8194s-34.4053.0005-34.4053.0005v7.8194s34.4053-.0005,34.4053-.0005Z"/>
                <path className="st0" d="M571.918,304.2576v-7.8194s-34.4053.0005-34.4053.0005v7.8194s34.4053-.0005,34.4053-.0005Z"/>
              </g>
              <g id="Layer_118">
                <path className="st0" d="M320.5334,63.3229l7.7784.8175,3.5971-34.225-7.7784-.8175-3.5971,34.225Z"/>
                <path className="st0" d="M267.2267,570.5146l7.7784.8175,3.5971-34.225-7.7784-.8175-3.5971,34.225Z"/>
              </g>
              <g id="Layer_119">
                <path className="st0" d="M345.2135,66.7725l7.6504,1.626,7.1543-33.6616-7.6504-1.626-7.1543,33.6616Z"/>
                <path className="st0" d="M239.1915,565.6142l7.6504,1.626,7.1543-33.6616-7.6504-1.626-7.1543,33.6616Z"/>
              </g>
              <g id="Layer_120">
                <path className="st0" d="M369.3668,72.8206l7.4384,2.417,10.6348-32.729-7.4384-2.417-10.6348,32.729Z"/>
                <path className="st0" d="M211.7657,557.8414l7.4384,2.417,10.6348-32.729-7.4384-2.417-10.6348,32.729Z"/>
              </g>
              <g id="Layer_121">
                <path className="st0" d="M392.7445,81.3601l7.1449,3.1812,13.9972-31.4377-7.1449-3.1812-13.9972,31.4377Z"/>
                <path className="st0" d="M185.3153,547.245l7.1449,3.1812,13.9972-31.4377-7.1449-3.1812-13.9972,31.4377Z"/>
              </g>
              <g id="Layer_122">
                <path className="st0" d="M415.141,92.3361l6.7732,3.9105,17.2063-29.8019-6.7732-3.9105-17.2063,29.8019Z"/>
                <path className="st0" d="M160.1561,533.9802l6.7732,3.9105,17.2063-29.8019-6.7732-3.9105-17.2063,29.8019Z"/>
              </g>
              <g id="Layer_123">
                <path className="st0" d="M436.2649,105.5514l6.3272,4.5968,20.2257-27.8395-6.3272-4.5968-20.2257,27.8395Z"/>
                <path className="st0" d="M136.5335,518.1141l6.3272,4.5968,20.2257-27.8395-6.3272-4.5968-20.2257,27.8395Z"/>
              </g>
              <g id="Layer_124">
                <path className="st0" d="M455.9033,120.8568l5.8119,5.233,23.0252-25.5726-5.8119-5.233-23.0252,25.5726Z"/>
                <path className="st0" d="M114.686,499.8246l5.8119,5.233,23.0252-25.5726-5.8119-5.233-23.0252,25.5726Z"/>
              </g>
              <g id="Layer_125">
                <path className="st0" d="M473.8248,138.1712l5.2329,5.8117,25.5715-23.0246-5.2329-5.8117-25.5715,23.0246Z"/>
                <path className="st0" d="M94.8726,479.3808l5.2329,5.8117,25.5715-23.0246-5.2329-5.8117-25.5715,23.0246Z"/>
              </g>
              <g id="Layer_126">
                <path className="st0" d="M489.8019,157.2944l4.5966,6.3268,27.8379-20.2252-4.5966-6.3268-27.8379,20.2252Z"/>
                <path className="st0" d="M77.2626,457.0181l4.5966,6.3268,27.8379-20.2252-4.5966-6.3268-27.8379,20.2252Z"/>
              </g>
              <g id="Layer_127">
                <path className="st0" d="M503.6854,177.9444l3.91,6.7722,29.7977-17.2042-3.91-6.7722-29.7977,17.2042Z"/>
                <path className="st0" d="M62.1036,432.8982l3.91,6.7722,29.7977-17.2042-3.91-6.7722-29.7977,17.2042Z"/>
              </g>
              <g id="Layer_128">
                <path className="st0" d="M515.3409,199.9729l3.1806,7.1436,31.4319-13.9946-3.1806-7.1436-31.4319,13.9946Z"/>
                <path className="st0" d="M49.5416,407.3632l3.1806,7.1436,31.4319-13.9946-3.1806-7.1436-31.4319,13.9946Z"/>
              </g>
              <g id="Layer_129">
                <path className="st0" d="M524.6337,223.0965l2.4164,7.4367,32.7216-10.6322-2.4164-7.4367-32.7216,10.6322Z"/>
                <path className="st0" d="M39.7218,380.6586l2.4164,7.4367,32.7216-10.6322-2.4164-7.4367-32.7216,10.6322Z"/>
              </g>
              <g id="Layer_130">
                <path className="st0" d="M531.4653,247.0589l1.626,7.6485,33.6532-7.1543-1.626-7.6485-33.6532,7.1543Z"/>
                <path className="st0" d="M32.7481,353.0808l1.626,7.6485,33.6532-7.1543-1.626-7.6485-33.6532,7.1543Z"/>
              </g>
              <g id="Layer_131">
                <path className="st0" d="M535.7626,271.6182l.8173,7.7765,34.2166-3.5961-.8173-7.7765-34.2166,3.5961Z"/>
                <path className="st0" d="M28.6953,324.9094l.8173,7.7765,34.2166-3.5961-.8173-7.7765-34.2166,3.5961Z"/>
              </g>
              <g id="Layer_132">
                <path className="st0" d="M295.5001,62.2917h7.8194s-.0005-34.4053-.0005-34.4053h-7.8194s.0005,34.4053.0005,34.4053Z"/>
                <path className="st0" d="M295.5079,572.1527h7.8194s-.0005-34.4053-.0005-34.4053h-7.8194s.0005,34.4053.0005,34.4053Z"/>
              </g>
            </g>
          </g>
        </svg>
      </div>
      <div className="countdown-timer">{secondsLeft}</div>
    </div>
  </>;
}
